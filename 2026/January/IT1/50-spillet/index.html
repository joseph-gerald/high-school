<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Sometype+Mono:ital,wght@0,400..700;1,400..700&family=Ubuntu:ital,wght@0,300;0,400;0,500;0,700;1,300;1,400;1,500;1,700&display=swap"
        rel="stylesheet">

    <link rel="stylesheet" href="style.css">
</head>

<body class="ubuntu-regular">
    <div>
        <h1 id="title">
            Velg antall spillere
        </h1>

        <div>
            <div id="players-init-container">
                <button id="decrease-players">
                    -
                </button>
                <input id="players-input" type="number" name="" id="" value="2" min="2">
                <button id="increase-players">
                    +
                </button>
            </div>

            <div id="players-container">
            </div>


            <div id="actions-container">
                <button id="roll-btn">
                    Kast Terning
                </button>
                <button id="restart-btn">
                    Start på nytt
                </button>
            </div>
        </div>
    </div>
</body>
<script>
    const ELMS = {
        title: document.getElementById("title"),
        decreasePlayers: document.getElementById("decrease-players"),
        increasePlayers: document.getElementById("increase-players"),
        playerCount: document.getElementById("players-input"),
        playersContainer: document.getElementById("players-container"),
        rollButton: document.getElementById("roll-btn"),
        restartButton: document.getElementById("restart-btn"),
    };

    const GOAL = 50;

    let playerCount = 0;
    let turn = 0;

    let timeoutArrays = [];

    let gameState = "live";

    [ELMS.decreasePlayers, ELMS.increasePlayers].forEach((elm, index) => {
        elm.onclick = () => {
            if (!index && ELMS.playerCount.value == 2) return;
            
            console.log({ elm, index })
            
            ELMS.playerCount.value -= index ? -1 : 1;
            ELMS.playerCount.oninput()
        }
    });

    function addPlayer(index) {
        const newPlayerElm = document.createElement("div");

        newPlayerElm.classList.add("player-container");
        newPlayerElm.setAttribute("i", index)
        newPlayerElm.setAttribute("score", 0)
        newPlayerElm.innerHTML = `
        <input class="player-name" placeholder="Spiller ${index}"></input>


        <p class="point-counter mono">
            0
        </p>
        `;

        ELMS.playersContainer.appendChild(newPlayerElm);
    }

    ELMS.playerCount.oninput = () => {
        const newPlayerCount = parseInt(ELMS.playerCount.value);
        const deltaPlayerCount = newPlayerCount - playerCount;

        if (deltaPlayerCount > 0) {
            for (let i = 0; i < deltaPlayerCount; i++) {
                addPlayer(playerCount + i + 1);
            }
        } else {
            for (let i = 0; i < -deltaPlayerCount; i++) {
                Array.from(ELMS.playersContainer.children).pop().remove();
            }
        }

        showActivePlayer();
        playerCount = newPlayerCount;
    }

    function showActivePlayer() {
        const playersElms = Array.from(ELMS.playersContainer.children);

        playersElms.forEach((elm, index) => {
            if (index == turn % playersElms.length) {
                elm.classList.add("active");
            } else {
                elm.classList.remove("active");
            }
        })
    }

    ELMS.rollButton.onclick = () => {
        if (gameState == "paused") return;

        turn++;

        const activePlayerElm = document.querySelector(".active");
        const activePlayerIndex = activePlayerElm.getAttribute("i");
        const counterElm = activePlayerElm.querySelector(".point-counter");

        counterElm.innerText = activePlayerElm.getAttribute("score");

        const outcome = Math.ceil(Math.random() * 6);
        const overshot = Math.max(outcome + parseInt(counterElm.innerText) - GOAL, 0);
        const finalScore = parseInt(counterElm.innerText) + outcome - overshot * 2;

        timeoutArrays[activePlayerIndex] ??= [];

        for (const timeout of timeoutArrays[activePlayerIndex]) {
            clearTimeout(timeout);
        }

        activePlayerElm.setAttribute("score", finalScore);

        for (let i = 0; i < outcome; i++) {
            const timeout = setTimeout(() => {
                counterElm.innerText = i >= overshot ? parseInt(counterElm.innerText) + 1 : parseInt(counterElm.innerText) - 1;
            }, i * 50);

            timeoutArrays[activePlayerIndex].push(timeout);
        }

        const markerElm = document.createElement("div");

        markerElm.innerHTML = `
        +${outcome}
        `;

        markerElm.style.position = "absolute";
        const leftOffset = Math.random() * activePlayerElm.clientWidth - 10;
        const topOffset = Math.random() * activePlayerElm.clientHeight - 10;

        markerElm.animate([
            {
                left: leftOffset + "px",
                top: topOffset + "px"
            },
            {
                left: leftOffset + "px",
                top: topOffset - 25 + "px",
                opacity: 0.8
            },
            {
                left: leftOffset + "px",
                top: topOffset - 50 + "px",
                opacity: 0
            }
        ], {
            duration: 900,
            easing: "linear"
        }).onfinish = () => {
            markerElm.remove();
        }

        activePlayerElm.appendChild(markerElm);

        if (finalScore == 50) {
            activePlayerElm.animate([
                {
                    transform: "rotate(0deg)"
                },
                {
                    transform: "rotate(360deg)"
                }
            ], {
                duration: 500
            });

            gameState = "paused";

            ELMS.title.innerText = `${activePlayerElm.querySelector("input").value || activePlayerElm.querySelector("input").placeholder} vant!`;

            return;
        }

        showActivePlayer();
    }

    ELMS.restartButton.onclick = () => {
        gameState = "live"
        playerCount = 0;

        ELMS.playersContainer.replaceChildren([]);
        ELMS.playerCount.oninput();
        
        ELMS.title.innerText = "Kast terning for å starte spillet"
    }

    ELMS.playerCount.oninput();
</script>
<style>

</style>

</html>